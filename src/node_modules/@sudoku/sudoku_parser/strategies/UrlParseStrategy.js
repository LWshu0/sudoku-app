import { ParseStrategy } from '@sudoku/sudoku_parser/strategies/ParseStrategy.js';
import { SUDOKU_SIZE,GRID_LENGTH  } from '@sudoku/constants';

export class UrlParseStrategy extends ParseStrategy {

  static #BD_PARAM_KEY = 'bd';

  static #extractBdParam(url) {
    try {
      const decodeUrl = decodeURIComponent(url);
      const urlObj = new URL(decodeUrl);
      return urlObj.searchParams.get(UrlParseStrategy.#BD_PARAM_KEY) || null;
      
    } catch (e) {
      return null;
    }
  }

  validate(input) {
    const bdParam = UrlParseStrategy.#extractBdParam(input);
    return !!bdParam && bdParam.length === GRID_LENGTH;
  }

  parse(url) {
    if (!this.validate(url)) return null;

    const bdParam = UrlParseStrategy.#extractBdParam(url);
    const grid = Array(SUDOKU_SIZE).fill(0).map(() => Array(SUDOKU_SIZE).fill(0));
    let index = 0;

    for (let row = 0; row < SUDOKU_SIZE; row++) {
      for (let col = 0; col < SUDOKU_SIZE; col++) {
        const num = Number(bdParam[index]);
        grid[row][col] = isNaN(num) ? 0 : num;
        index++;
      }
    }

    return grid;
  }
}